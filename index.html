<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Disparador WhatsApp BR</title>
    
    <!-- ÍCONES -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    
    <!-- BIBLIOTECA PARA LER EXCEL (SheetJS) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <script>
      // ============================================================
      // CONFIGURAÇÃO DA API
      // ============================================================
      const API_URL = "https://script.google.com/macros/s/AKfycbznZNErEiLFYxlV6bNG0f_318rw6o15Qsi9-N5glb2Kcdstdowkf926pq6IOcY7OCA0qQ/exec"; 
      // ============================================================
    </script>

    <style>
      /* --- VARIAVEIS E RESET --- */
      :root {
        --primary: #008069; 
        --primary-dark: #006d59; 
        --bg-color: #eef2f5;
        --card-bg: #ffffff; 
        --text-main: #1c1e21; 
        --text-sec: #667781;
        --danger: #d32f2f; 
        --warning-bg: #ffebee; 
        --success: #4caf50; 
        --blue-restore: #2196f3;
      }
      * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
      
      body { 
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
        background-color: var(--bg-color); 
        margin: 0; padding: 0; 
        color: var(--text-main); 
        padding-bottom: 80px; 
      }

      /* --- HEADER --- */
      header { 
        background: linear-gradient(180deg, var(--primary) 0%, var(--primary-dark) 100%); 
        color: white; 
        padding: 15px 20px; 
        text-align: center; 
        position: sticky; 
        top: 0; 
        z-index: 100; 
        box-shadow: 0 2px 5px rgba(0,0,0,0.15); 
        display: flex; justify-content: space-between; align-items: center;
      }
      h1 { margin: 0; font-size: 1.1rem; font-weight: 600; letter-spacing: 0.5px; }
      
      /* --- SETUP WARNING --- */
      #setup-warning {
        background: #fff3cd; color: #856404; padding: 20px; text-align: center;
        border-bottom: 1px solid #ffeeba; display: none;
      }

      .container { padding: 15px; max-width: 600px; margin: 0 auto; }

      /* --- SEARCH & INPUTS --- */
      .search-bar-container {
        background: white; padding: 10px 15px; border-radius: 25px; margin-bottom: 15px;
        display: flex; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        border: 1px solid transparent; transition: all 0.3s;
      }
      .search-bar-container:focus-within { border-color: var(--primary); box-shadow: 0 4px 8px rgba(0,128,105,0.15); }
      .search-bar-container .material-icons { color: #999; margin-right: 10px; }
      .search-bar-container input { border: none; outline: none; width: 100%; font-size: 1rem; color: var(--text-main); background: transparent; }

      /* --- CARDS --- */
      .import-card {
        background: white; padding: 30px 20px; border-radius: 15px;
        text-align: center; box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        border: 2px dashed #ccc; transition: all 0.3s;
      }
      .import-card:hover { border-color: var(--primary); background: #f9fffd; }
      .import-icon { font-size: 48px; color: var(--primary); margin-bottom: 10px; }

      .file-input-wrapper { position: relative; overflow: hidden; display: inline-block; margin-top: 15px; }
      .file-input-wrapper input[type=file] { font-size: 100px; position: absolute; left: 0; top: 0; opacity: 0; cursor: pointer; }
      .btn-select-file {
        background: var(--primary); color: white; padding: 12px 25px;
        border-radius: 30px; font-weight: 600; display: inline-flex; align-items: center; gap: 8px;
        box-shadow: 0 4px 10px rgba(0,128,105,0.2); cursor: pointer;
      }
      .import-result {
        margin-top: 20px; background: white; padding: 20px; border-radius: 12px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.08); display: none;
      }
      .result-item { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #eee; }
      .result-value { font-weight: bold; }
      .val-success { color: var(--success); }
      .val-warn { color: #f57c00; }
      .val-danger { color: var(--danger); }

      /* --- UI ELEMENTS --- */
      #loading-overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(255,255,255,0.95); z-index: 2000;
        display: flex; flex-direction: column; justify-content: center; align-items: center;
        transition: opacity 0.3s; pointer-events: none; opacity: 0;
      }
      .spinner {
        width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid var(--primary);
        border-radius: 50%; animation: spin 0.8s linear infinite; margin-bottom: 10px;
      }
      .loading-text { color: var(--primary); font-weight: 600; font-size: 0.9rem; }
      @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

      #sync-indicator {
        position: fixed; top: 60px; right: 15px;
        background: rgba(0,0,0,0.7); color: white; padding: 5px 10px; border-radius: 15px;
        font-size: 0.7rem; z-index: 99; display: none; align-items: center; gap: 5px;
      }

      #toast-container { position: fixed; bottom: 85px; left: 50%; transform: translateX(-50%); z-index: 3000; width: 90%; max-width: 400px; text-align: center; pointer-events: none; }
      .toast {
        background: rgba(30, 30, 30, 0.9); color: white; padding: 12px 20px; border-radius: 25px;
        margin-top: 10px; display: inline-block; font-size: 0.9rem; box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        animation: fadeUp 0.3s ease;
      }
      @keyframes fadeUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

      .view-section { display: none; opacity: 0; transition: opacity 0.3s; }
      .view-section.active { display: block; opacity: 1; }

      /* --- BOTÕES FLUTUANTES --- */
      .fab-container { position: fixed; bottom: 85px; right: 20px; display: flex; flex-direction: column; gap: 15px; z-index: 1000; }
      .fab-btn {
        width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center;
        box-shadow: 0 4px 10px rgba(0,0,0,0.2); cursor: pointer; transition: transform 0.2s; border: none; outline: none; color: white;
      }
      .fab-btn:active { transform: scale(0.95); }
      .fab-sync { background-color: white; color: var(--primary); }
      .fab-add { background-color: var(--primary); }

      /* --- CONTACT CARDS --- */
      .contact-card { 
        background: var(--card-bg); padding: 15px; border-radius: 12px; 
        box-shadow: 0 2px 8px rgba(0,0,0,0.04); margin-bottom: 12px; 
        display: flex; justify-content: space-between; align-items: center; 
        border-left: 4px solid transparent; transition: transform 0.2s, opacity 0.3s; 
      }
      .contact-card.removing { transform: translateX(100%); opacity: 0; }
      .contact-card.restoring { transform: translateX(-100%); opacity: 0; }
      .card-pending { border-left-color: var(--primary); }
      .card-done { border-left-color: var(--text-sec); opacity: 0.8; }
      .card-invalid { border-left-color: var(--danger); background-color: #fffbfb; }
      .card-invalid .contact-phone { color: var(--danger); font-weight: 700; }
      
      .contact-info { flex-grow: 1; padding-right: 10px; overflow: hidden; }
      .contact-name { font-weight: 700; font-size: 1rem; color: var(--text-main); margin-bottom: 4px; }
      .contact-phone { color: var(--text-sec); font-size: 0.85rem; display: flex; align-items: center; gap: 4px; }
      .invalid-badge { background: var(--warning-bg); color: var(--danger); font-size: 0.7rem; padding: 2px 6px; border-radius: 4px; margin-left: 5px; }

      .actions { display: flex; gap: 8px; }
      .btn-icon { background: #f0f2f5; border-radius: 50%; width: 42px; height: 42px; display: flex; align-items: center; justify-content: center; transition: all 0.2s; box-shadow: 0 1px 3px rgba(0,0,0,0.1); cursor: pointer; border: none; }
      .btn-icon:disabled { opacity: 0.5; cursor: not-allowed; }
      
      .material-icons.send { color: var(--primary); }
      .material-icons.edit { color: var(--text-sec); }
      .material-icons.restore { color: var(--blue-restore); }
      .material-icons.check { color: #aaa; }
      .btn-check { background-color: white; border: 1px solid #ddd; }
      .btn-check:active { background-color: #e8f5e9; border-color: var(--success); }

      /* --- CONFIG --- */
      .config-card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
      .tag-highlight-box { background: #e0f2f1; border: 1px dashed var(--primary); border-radius: 8px; padding: 15px; margin-bottom: 20px; display: flex; align-items: center; justify-content: space-between; }
      .tag-chip { background: white; border: 1px solid var(--primary); color: var(--primary); padding: 5px 10px; border-radius: 15px; font-weight: bold; cursor: pointer; display: flex; align-items: center; gap: 5px; }
      .config-card textarea { width: 100%; height: 140px; padding: 15px; border: 1px solid #ddd; border-radius: 10px; font-size: 1rem; resize: none; background: #fafafa; }
      .btn-save-config { background-color: var(--primary); color: white; padding: 14px; border-radius: 30px; width: 100%; font-weight: 600; font-size: 1rem; margin-top: 15px; border: none; cursor: pointer; display: flex; justify-content: center; gap: 8px; }
      
      .btn-restore-all { background-color: #e3f2fd; color: var(--blue-restore); border: 1px solid #bbdefb; padding: 10px 20px; border-radius: 25px; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 8px; margin: 0 auto 15px auto; cursor: pointer; width: 100%; max-width: 250px; }

      /* --- FOOTER & NAV --- */
      .app-footer { text-align: center; margin-top: 30px; margin-bottom: 20px; font-size: 0.75rem; color: #999; font-weight: 500; }
      
      .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; background: white; display: flex; justify-content: space-around; padding: 10px 0 15px 0; z-index: 900; box-shadow: 0 -5px 20px rgba(0,0,0,0.05); border-radius: 20px 20px 0 0; }
      .nav-item { border: none; background: none; color: #999; font-size: 0.7rem; display: flex; flex-direction: column; align-items: center; width: 25%; cursor: pointer; }
      .nav-item.active { color: var(--primary); }
      .nav-item .material-icons { font-size: 26px; margin-bottom: 4px; }

      /* --- MODAIS --- */
      .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 2500; backdrop-filter: blur(3px); }
      .modal { background: white; width: 85%; max-width: 350px; padding: 25px; border-radius: 15px; box-shadow: 0 15px 40px rgba(0,0,0,0.2); animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
      @keyframes popIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
      .modal h2 { margin-top: 0; font-size: 1.2rem; color: #333; }
      .modal p { color: #666; font-size: 0.95rem; line-height: 1.5; margin-bottom: 20px; }
      .modal input, .modal textarea { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem; margin-top: 5px; display:block; margin-bottom: 15px; }
      .modal-buttons { display: flex; justify-content: flex-end; gap: 10px; }
      .btn-confirm { background: var(--primary); color: white; padding: 10px 20px; border-radius: 20px; font-weight: 600; border: none; cursor: pointer; }
      .btn-cancel { background: #f5f5f5; color: #666; padding: 10px 20px; border-radius: 20px; font-weight: 600; border: none; cursor: pointer; }
      
      .empty-state { text-align: center; padding: 50px 20px; color: #999; }
      .empty-state .material-icons { font-size: 60px; color: #e0e0e0; margin-bottom: 10px; }
      #system-error { display:none; background:#ffeba; color: #d32f2f; padding:10px; text-align:center; font-size:0.8rem; margin:10px; border-radius:8px; border:1px solid #ffcdd2; }
    </style>
  </head>
  <body>

    <header>
      <h1>Disparador WhatsApp BR</h1>
    </header>

    <!-- Indicador de Sincronia (ADICIONADO DE VOLTA) -->
    <div id="sync-indicator">
      <span class="material-icons" style="font-size:14px; animation:spin 1s infinite linear;">sync</span> Atualizando...
    </div>

    <div id="setup-warning">
      ⚠️ <b>Configuração Necessária</b><br>
      Abra o arquivo <code>index.html</code> e cole sua <b>API_URL</b> na linha 18.
    </div>

    <div id="toast-container"></div>
    <div id="loading-overlay"><div class="spinner"></div><div class="loading-text" id="loading-text">Carregando...</div></div>

    <!-- FABs -->
    <div class="fab-container">
      <button class="fab-btn fab-add" id="fabAddContact" onclick="abrirAdicionar()" title="Adicionar Contato"><span class="material-icons">person_add</span></button>
      <button class="fab-btn fab-sync" onclick="sincronizarComNuvem(true)" title="Atualizar"><span class="material-icons">sync</span></button>
    </div>

    <div class="container">
      <div id="system-error"></div>

      <!-- BARRA DE PESQUISA -->
      <div id="searchArea" class="search-bar-container">
        <span class="material-icons">search</span>
        <input type="text" id="searchInput" placeholder="Buscar por nome ou telefone..." onkeyup="filtrarListas()" autocomplete="off">
      </div>

      <!-- ABA 1: CONTATOS -->
      <div id="view-home" class="view-section active">
        <div id="contactList"></div>
      </div>

      <!-- ABA 2: ENVIADOS -->
      <div id="view-enviados" class="view-section">
        <div style="padding: 10px 0; color: #666; font-size: 0.9rem; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; text-align: center;">
          Histórico
        </div>
        <button class="btn-restore-all" onclick="restaurarTodos()">
          <span class="material-icons">settings_backup_restore</span> Restaurar Todos
        </button>
        <div id="enviadosList"></div>
      </div>

      <!-- ABA 3: IMPORTAR -->
      <div id="view-import" class="view-section">
        <div class="import-card">
          <div class="import-icon"><span class="material-icons" style="font-size:60px">cloud_upload</span></div>
          <h3>Importar Dados</h3>
          <p style="color:#666; font-size:0.9rem; margin-bottom:20px;">
            Suporta <strong>.xlsx, .xls e .csv</strong>.<br>
            Colunas necessárias: <strong>Nome</strong> e <strong>Telefone</strong>.
          </p>
          
          <div class="file-input-wrapper">
            <label class="btn-select-file">
              <span class="material-icons">folder_open</span> Selecionar Arquivo
              <input type="file" id="fileInput" accept=".csv, .xlsx, .xls" onchange="processarArquivo()">
            </label>
          </div>
        </div>

        <div id="importResult" class="import-result">
          <h4 style="margin-top:0; color:var(--primary)">Relatório</h4>
          <div class="result-item">
            <span>Novos (Add):</span>
            <span class="result-value val-success" id="resAdded">0</span>
          </div>
          <div class="result-item">
            <span>Já na Lista:</span>
            <span class="result-value val-warn" id="resExists">0</span>
          </div>
          <div class="result-item" style="border-bottom:none">
            <span>Repetidos no Arquivo:</span>
            <span class="result-value val-danger" id="resDup">0</span>
          </div>
          <button class="btn-save-config" onclick="concluirImportacao()" style="margin-top:15px">
            Concluir
          </button>
        </div>
      </div>

      <!-- ABA 4: CONFIG -->
      <div id="view-config" class="view-section">
        <div class="config-card">
          <div class="tag-highlight-box">
            <div class="tag-info">
              <h4>Variável de Nome</h4>
              <p>Substitui pelo nome do cliente.</p>
            </div>
            <div class="tag-chip" onclick="copiarTag()">
              <span class="material-icons" style="font-size:16px">content_copy</span> {nome}
            </div>
          </div>
          <label style="margin-left:5px;">Modelo da Mensagem</label>
          <textarea id="templateMsg" placeholder="Ex: Olá {nome}, temos novidades!"></textarea>
          <button class="btn-save-config" onclick="salvarTemplate()">
            <span class="material-icons">save</span> Salvar Modelo
          </button>
        </div>
        
        <!-- CRÉDITOS -->
        <div class="app-footer">
          Desenvolvido por Thiego Pereira
        </div>
      </div>
    </div>

    <!-- MENU DE NAVEGAÇÃO -->
    <nav class="bottom-nav">
      <button class="nav-item active" onclick="mudarAba('home', this)">
        <span class="material-icons">people</span><span>Contatos</span>
      </button>
      <button class="nav-item" onclick="mudarAba('enviados', this)">
        <span class="material-icons">task_alt</span><span>Enviados</span>
      </button>
      <button class="nav-item" onclick="mudarAba('import', this)">
        <span class="material-icons">upload_file</span><span>Importar</span>
      </button>
      <button class="nav-item" onclick="mudarAba('config', this)">
        <span class="material-icons">settings</span><span>Ajustes</span>
      </button>
    </nav>

    <!-- MODAIS -->
    <div id="modalConfirm" class="modal-overlay">
      <div class="modal">
        <h2 id="confirmTitle">Confirmação</h2>
        <p id="confirmText">Tem certeza?</p>
        <div class="modal-buttons">
          <button class="btn-cancel" onclick="fecharModal('modalConfirm')">Não</button>
          <button class="btn-confirm" id="btnConfirmYes">Sim</button>
        </div>
      </div>
    </div>

    <div id="modalEdit" class="modal-overlay">
      <div class="modal">
        <h2>Editar Contato</h2>
        <input type="hidden" id="editId">
        <label>Nome</label><input type="text" id="editName">
        <label>WhatsApp</label><input type="tel" id="editPhone">
        <div class="modal-buttons">
          <button class="btn-cancel" onclick="fecharModal('modalEdit')">Cancelar</button>
          <button class="btn-confirm" onclick="confirmarEdicao()">Salvar</button>
        </div>
      </div>
    </div>

    <!-- MODAL ADICIONAR (NOVO) -->
    <div id="modalAdd" class="modal-overlay">
      <div class="modal">
        <h2>Adicionar Contato</h2>
        <label>Nome</label>
        <input type="text" id="addName" placeholder="Nome do cliente">
        <label>WhatsApp</label>
        <input type="tel" id="addPhone" placeholder="DDD + Número">
        <div class="modal-buttons">
          <button class="btn-cancel" onclick="fecharModal('modalAdd')">Cancelar</button>
          <button class="btn-confirm" onclick="confirmarAdicionar()">Adicionar</button>
        </div>
      </div>
    </div>

    <div id="modalSend" class="modal-overlay">
      <div class="modal">
        <h2>Enviar Mensagem</h2>
        <input type="hidden" id="sendId">
        <input type="hidden" id="sendPhone">
        <input type="hidden" id="sendName"> 
        <textarea id="sendMessage" rows="6"></textarea>
        <div class="modal-buttons">
          <button class="btn-cancel" onclick="fecharModal('modalSend')">Voltar</button>
          <button class="btn-confirm" onclick="finalizarEnvio()">
            Enviar <span class="material-icons" style="font-size:16px; vertical-align:middle">open_in_new</span>
          </button>
        </div>
      </div>
    </div>

    <script>
      // CHAVE DO CACHE LOCAL
      const CACHE_KEY = 'app_whatsapp_br_v1';

      // --- UI HELPERS ---
      
      function showLoader(show, text="Carregando...") {
        const el = document.getElementById('loading-overlay');
        document.getElementById('loading-text').innerText = text;
        if (show) { el.style.opacity = "1"; el.style.pointerEvents = "all"; } 
        else { el.style.opacity = "0"; el.style.pointerEvents = "none"; }
      }

      function toggleSyncIndicator(show) {
        // Agora o elemento existe no HTML, então não vai dar erro
        const indicator = document.getElementById('sync-indicator');
        if(indicator) indicator.style.display = show ? 'flex' : 'none';
      }

      function showToast(msg) {
        const container = document.getElementById('toast-container');
        const toast = document.createElement('div');
        toast.className = 'toast';
        toast.innerText = msg;
        container.appendChild(toast);
        setTimeout(() => { toast.style.opacity = '0'; setTimeout(() => toast.remove(), 300); }, 3000);
      }

      function askConfirm(title, text, callback) {
        document.getElementById('confirmTitle').innerText = title;
        document.getElementById('confirmText').innerText = text;
        const btnYes = document.getElementById('btnConfirmYes');
        const newBtn = btnYes.cloneNode(true);
        btnYes.parentNode.replaceChild(newBtn, btnYes);
        newBtn.onclick = function() { fecharModal('modalConfirm'); callback(); };
        document.getElementById('modalConfirm').style.display = 'flex';
      }

      function copiarTag() {
        const el = document.createElement('textarea');
        el.value = "{nome}";
        document.body.appendChild(el);
        el.select();
        document.execCommand('copy');
        document.body.removeChild(el);
        showToast("Tag {nome} copiada!");
      }

      // Validação: Aceita 10 ou 11 dígitos
      function validarTelefone(fone) {
        if (!fone) return false;
        const numeros = String(fone).replace(/\D/g, '');
        return numeros.length >= 10 && numeros.length <= 11;
      }

      // --- VARIÁVEIS GLOBAIS ---
      let listaContatos = [];
      let listaEnviados = [];
      let templateAtual = "";

      // --- INICIALIZAÇÃO ---
      window.onload = function() {
        if (!API_URL) { document.getElementById('setup-warning').style.display='block'; return; }
        carregarLocalmente();
        sincronizarComNuvem();
      };

      // Carrega do LocalStorage (Instantâneo)
      function carregarLocalmente() {
        const cached = localStorage.getItem(CACHE_KEY);
        if (cached) {
            try {
                const data = JSON.parse(cached);
                listaContatos = data.contatos || [];
                listaEnviados = data.enviados || [];
                templateAtual = data.template || "";
                atualizarInterface();
            } catch (e) { console.error(e); }
        }
      }

      // Salva no LocalStorage
      function salvarLocalmente() {
        const data = { contatos: listaContatos, enviados: listaEnviados, template: templateAtual, timestamp: new Date().getTime() };
        localStorage.setItem(CACHE_KEY, JSON.stringify(data));
      }

      // --- API CLIENT ---
      async function callApi(action, params={}, method='POST') {
        if(!API_URL) throw new Error("API_URL não configurada.");
        
        // Se for GET, monta a URL com parâmetros (para 'getDados' principalmente)
        if (method === 'GET') {
           const url = new URL(API_URL);
           url.searchParams.append('action', action);
           for (const key in params) {
             url.searchParams.append(key, params[key]);
           }
           const response = await fetch(url.toString());
           return await response.json();
        }

        // Padrão POST
        const response = await fetch(API_URL, {
          method: 'POST',
          body: JSON.stringify({ action, params }),
          headers: { "Content-Type": "text/plain;charset=utf-8" }
        });
        return await response.json();
      }

      // Pega dados novos da planilha (Com opção de Forçar)
      function sincronizarComNuvem(force = false) {
        if(force) showLoader(true, "Atualizando...");
        toggleSyncIndicator(true);
        
        // Usa GET para leitura
        callApi('getDados', {}, 'GET')
          .then(res => {
             toggleSyncIndicator(false);
             if(force) showLoader(false);
             
             if (res.success) {
                 listaContatos = res.contatos || [];
                 listaEnviados = res.enviados || [];
                 templateAtual = res.template || "";
                 salvarLocalmente();
                 atualizarInterface();
                 if(force) showToast("Lista atualizada!");
             } else {
                 console.error("Erro API:", res.error);
                 if(force) showToast("Erro: " + res.error);
             }
          })
          .catch(err => { 
             toggleSyncIndicator(false);
             if(force) showLoader(false);
             console.error(err); 
             if(force) showToast("Erro de conexão.");
          });
      }

      function atualizarInterface() {
        const txtMsg = document.getElementById('templateMsg');
        if(txtMsg && document.activeElement !== txtMsg) {
            txtMsg.value = templateAtual;
        }
        filtrarListas();
      }

      // --- RENDERIZAÇÃO DAS LISTAS ---

      function mudarAba(aba, btn) {
        document.querySelectorAll('.view-section').forEach(e => e.classList.remove('active'));
        document.getElementById('view-' + aba).classList.add('active');
        document.querySelectorAll('.nav-item').forEach(e => e.classList.remove('active'));
        if(btn) btn.classList.add('active');

        const searchInput = document.getElementById('searchInput');
        if (searchInput) searchInput.value = ""; 

        const searchArea = document.getElementById('searchArea');
        // Controle de visibilidade do FAB Adicionar
        const fabAdd = document.getElementById('fabAddContact');
        
        if (aba === 'config' || aba === 'import') {
            searchArea.style.display = 'none';
            if(fabAdd) fabAdd.style.display = 'none';
        } else {
            searchArea.style.display = 'flex';
            // Mostrar botão de adicionar apenas na aba home
            if(fabAdd) fabAdd.style.display = (aba === 'home') ? 'flex' : 'none';
            filtrarListas();
        }
      }

      function filtrarListas() {
        if(document.getElementById('view-home').classList.contains('active')) {
            renderizarLista();
        } else if (document.getElementById('view-enviados').classList.contains('active')) {
            renderizarEnviados();
        }
      }

      function renderizarLista() {
        const div = document.getElementById('contactList');
        div.innerHTML = "";
        
        const termo = document.getElementById('searchInput').value.toLowerCase();

        // Filtra e Remove itens vazios ou inválidos da renderização
        const filtrados = listaContatos.filter(c => {
            if (!c || c.length < 3 || !c[0]) return false;
            const nome = (c[1] || "").toLowerCase();
            const fone = (c[2] || "").toString();
            return nome.includes(termo) || fone.includes(termo);
        });

        if (filtrados.length === 0) {
          div.innerHTML = `<div class="empty-state"><span class="material-icons">search_off</span><p>${termo ? 'Nenhum contato encontrado.' : 'Tudo pronto! Lista vazia.'}</p></div>`;
          return;
        }

        filtrados.forEach((c) => {
          const id = c[0];
          const nome = c[1] || "Sem Nome";
          const fone = c[2] || "";
          
          const isValid = validarTelefone(fone);
          const cardClass = isValid ? 'card-pending' : 'card-invalid';
          const badge = isValid ? '' : `<span class="invalid-badge"><span class="material-icons warning">warning</span> Inválido</span>`;

          const el = document.createElement('div');
          el.className = `contact-card ${cardClass}`;
          el.id = 'card-' + id;
          
          el.innerHTML = `
            <div class="contact-info">
              <div class="contact-name">${nome} ${badge}</div>
              <div class="contact-phone"><span class="material-icons" style="font-size:14px">phone</span> ${fone}</div>
            </div>
            <div class="actions">
              <button class="btn-icon" ${!isValid ? 'disabled' : ''} onclick="prepararEnvio('${id}', '${safe(nome)}', '${safe(fone)}')" title="Enviar">
                <span class="material-icons send">send</span>
              </button>
              <button class="btn-icon btn-check" onclick="moverEnviado('${id}', '${safe(nome)}', '${safe(fone)}')" title="Concluir">
                <span class="material-icons check">check</span>
              </button>
              <button class="btn-icon" onclick="abrirEdicao('${id}', '${safe(nome)}', '${safe(fone)}')" title="Editar">
                <span class="material-icons edit">edit</span>
              </button>
            </div>
          `;
          div.appendChild(el);
        });
      }

      function renderizarEnviados() {
        const div = document.getElementById('enviadosList');
        div.innerHTML = "";

        const termo = document.getElementById('searchInput').value.toLowerCase();

        const filtrados = listaEnviados.filter(c => {
            if (!c || c.length < 3) return false;
            const nome = (c[1] || "").toLowerCase();
            const fone = (c[2] || "").toString();
            return nome.includes(termo) || fone.includes(termo);
        });

        if (filtrados.length === 0) {
          div.innerHTML = `<div class="empty-state"><span class="material-icons">history</span><p>Histórico vazio.</p></div>`;
          return;
        }

        filtrados.forEach((c) => {
          const id = c[0];
          const nome = c[1];
          const fone = c[2];
          const data = c[3] || ""; 

          const el = document.createElement('div');
          el.className = 'contact-card card-done';
          el.id = 'card-env-' + id;

          el.innerHTML = `
            <div class="contact-info">
              <div class="contact-name">${nome}</div>
              <div class="contact-phone">${fone}</div>
              <div class="contact-date">Enviado: ${data}</div>
            </div>
            <div class="actions">
              <button class="btn-icon" onclick="restaurarContato('${id}', '${safe(nome)}', '${safe(fone)}')" title="Restaurar">
                <span class="material-icons restore">undo</span>
              </button>
            </div>
          `;
          div.appendChild(el);
        });
      }

      function safe(str) { return str ? str.replace(/'/g, "").replace(/"/g, "") : ""; }

      // --- IMPORTAÇÃO DE ARQUIVO (Excel/CSV) ---
      function processarArquivo() {
        const fileInput = document.getElementById('fileInput');
        const file = fileInput.files[0];
        if (!file) return;

        showLoader(true, "Lendo arquivo...");
        
        const reader = new FileReader();
        reader.onload = function(e) {
          const data = new Uint8Array(e.target.result);
          // Lê o arquivo usando SheetJS
          const workbook = XLSX.read(data, {type: 'array'});
          const sheetName = workbook.SheetNames[0];
          const sheet = workbook.Sheets[sheetName];
          // Converte para JSON
          const json = XLSX.utils.sheet_to_json(sheet);
          
          showLoader(true, "Processando contatos...");
          
          // Envia JSON pronto para o Google Apps Script
          callApi('importarContatos', {lista: json})
            .then(resultado => {
               showLoader(false);
               if(resultado.success) {
                 document.getElementById('resAdded').innerText = resultado.adicionados;
                 document.getElementById('resExists').innerText = resultado.jaNaLista;
                 document.getElementById('resDup').innerText = resultado.duplicadosNoArquivo;
                 document.getElementById('importResult').style.display = 'block';
                 showToast("Importação concluída!");
               } else {
                 alert("Erro na importação: " + resultado.error);
               }
            })
            .catch(err => {
               showLoader(false);
               alert("Erro servidor: " + err);
            });
        };
        reader.readAsArrayBuffer(file);
      }

      function concluirImportacao() {
        document.getElementById('importResult').style.display = 'none';
        document.getElementById('resAdded').innerText = "0";
        document.getElementById('resExists').innerText = "0";
        document.getElementById('resDup').innerText = "0";
        document.getElementById('fileInput').value = "";
        
        // Limpa cache local para garantir integridade
        localStorage.removeItem(CACHE_KEY);
        listaContatos = [];
        listaEnviados = [];

        // Volta para a home
        const homeBtn = document.querySelector('.nav-item[onclick*="home"]');
        mudarAba('home', homeBtn);
        
        // Força sincronização
        sincronizarComNuvem(true);
      }

      // --- AÇÕES DO USUÁRIO ---

      function restaurarTodos() {
        if (listaEnviados.length === 0) { showToast("A lista já está vazia."); return; }
        
        askConfirm("Restaurar Tudo", "Mover todo o histórico de volta para pendentes?", () => {
          showLoader(true, "Restaurando...");
          callApi('restaurarTodosContatos')
            .then(res => {
               showLoader(false);
               showToast(res.message || "Restaurado!");
               sincronizarComNuvem(true);
            })
            .catch(err => {
               showLoader(false);
               showToast("Erro: " + err);
            });
        });
      }

      function moverEnviado(id, nome, fone) {
        askConfirm("Concluir", `Marcar ${nome} como enviado?`, () => {
          const card = document.getElementById('card-' + id);
          if(card) card.classList.add('removing');
          
          const index = listaContatos.findIndex(c => c[0] == id);
          if(index > -1) {
             const item = listaContatos.splice(index, 1)[0];
             item[3] = new Date().toLocaleString(); 
             listaEnviados.push(item);
             salvarLocalmente();
          }
          callApi('moverParaEnviados', {id, nome, numero: fone});
          setTimeout(() => { filtrarListas(); showToast("Concluído!"); }, 300);
        });
      }

      function restaurarContato(id, nome, fone) {
        askConfirm("Restaurar", `Devolver ${nome} para pendentes?`, () => {
          const card = document.getElementById('card-env-' + id);
          if(card) card.classList.add('restoring');
          
          const index = listaEnviados.findIndex(c => c[0] == id);
          if(index > -1) {
             const item = listaEnviados.splice(index, 1)[0];
             listaContatos.push(item);
             salvarLocalmente();
          }
          callApi('moverParaContatos', {id, nome, numero: fone});
          setTimeout(() => { filtrarListas(); showToast("Restaurado!"); }, 300);
        });
      }

      function abrirAdicionar() {
        document.getElementById('addName').value = "";
        document.getElementById('addPhone').value = "";
        document.getElementById('modalAdd').style.display = 'flex';
      }

      function confirmarAdicionar() {
        const nome = document.getElementById('addName').value;
        const fone = document.getElementById('addPhone').value;

        if (!nome || !fone) {
          showToast("Preencha todos os campos.");
          return;
        }

        if (!validarTelefone(fone)) {
          showToast("Número de telefone inválido.");
          return;
        }

        showLoader(true, "Adicionando...");
        callApi('adicionarContato', {nome, telefone: fone})
          .then(res => {
             showLoader(false);
             if (res.success) {
               showToast("Adicionado com sucesso!");
               fecharModal('modalAdd');
               // Adiciona localmente (Otimista)
               listaContatos.push([res.id, nome, fone]);
               salvarLocalmente();
               filtrarListas();
             } else {
               alert("Erro: " + res.error);
             }
          })
          .catch(err => {
             showLoader(false);
             alert("Erro no servidor: " + err);
          });
      }

      function confirmarEdicao() {
        const id = document.getElementById('editId').value;
        const nome = document.getElementById('editName').value;
        const fone = document.getElementById('editPhone').value;
        
        const index = listaContatos.findIndex(c => c[0] == id);
        if(index > -1) {
            listaContatos[index][1] = nome;
            listaContatos[index][2] = fone;
            salvarLocalmente();
            filtrarListas();
        }
        fecharModal('modalEdit');
        showToast("Editado! Sincronizando...");
        callApi('salvarEdicao', {id, nome, numero: fone});
      }

      function abrirEdicao(id, nome, fone) {
        document.getElementById('editId').value = id;
        document.getElementById('editName').value = nome;
        document.getElementById('editPhone').value = fone;
        document.getElementById('modalEdit').style.display = 'flex';
      }

      function prepararEnvio(id, nome, fone) {
        let msg = templateAtual.replace(/{nome}/gi, nome);
        document.getElementById('sendId').value = id;
        document.getElementById('sendPhone').value = fone;
        document.getElementById('sendName').value = nome; 
        document.getElementById('sendMessage').value = msg;
        document.getElementById('modalSend').style.display = 'flex';
      }

      function finalizarEnvio() {
        let foneInput = document.getElementById('sendPhone').value;
        let nome = document.getElementById('sendName').value;
        let msg = document.getElementById('sendMessage').value;
        let id = document.getElementById('sendId').value;
        
        let fone = String(foneInput).replace(/\D/g, ''); 
        if (fone.length >= 10 && fone.length <= 11) fone = '55' + fone;
        else if (!fone.startsWith('55') && fone.length > 0) fone = '55' + fone;

        const link = "https://api.whatsapp.com/send?phone=" + fone + "&text=" + encodeURIComponent(msg);
        const a = document.createElement('a');
        a.href = link; a.target = "_blank"; a.rel = "noopener noreferrer";
        a.click();
        
        fecharModal('modalSend');
        showToast("WhatsApp aberto!");

        const card = document.getElementById('card-' + id);
        if(card) card.classList.add('removing');
        
        const index = listaContatos.findIndex(c => c[0] == id);
        if(index > -1) {
             const item = listaContatos.splice(index, 1)[0];
             item[3] = new Date().toLocaleString(); 
             listaEnviados.push(item);
             salvarLocalmente();
        }
        setTimeout(() => filtrarListas(), 500);
        callApi('moverParaEnviados', {id, nome, numero: foneInput});
      }

      function salvarTemplate() {
        const msg = document.getElementById('templateMsg').value;
        templateAtual = msg;
        salvarLocalmente();
        showToast("Salvo localmente. Enviando...");
        callApi('salvarTemplate', {mensagem: msg}).then(() => showToast("Salvo na nuvem!"));
      }

      function fecharModal(id) { document.getElementById(id).style.display = 'none'; }
    </script>
  </body>
</html>
